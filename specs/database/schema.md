# Specification: Database Schema

**Created**: 2026-01-04
**Status**: Draft
**Database**: Neon Serverless PostgreSQL
**ORM**: SQLModel (Python)

## Overview

The database stores two primary entities:

1. **users**: User accounts managed by Better Auth (authentication metadata)
2. **tasks**: Todo items created by users (user-generated data)

The schema enforces user isolation through foreign key relationships and unique constraints.

---

## Tables

### users (Managed by Better Auth)

**Purpose**: Store user account information. This table is created and managed by Better Auth; we do not manually insert/update users.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | VARCHAR(255) | PRIMARY KEY | Unique user identifier (UUID or similar) generated by Better Auth |
| email | VARCHAR(255) | UNIQUE, NOT NULL | User's email address; must be unique across all users |
| password_hash | TEXT | NOT NULL | Bcrypt-hashed password; never stored in plaintext |
| name | VARCHAR(255) | NOT NULL | User's display name |
| created_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | Account creation timestamp |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | Last profile update timestamp |

**Example Row**:

```
id: 'user_abc123'
email: 'alice@example.com'
password_hash: '$2b$12$...'
name: 'Alice'
created_at: 2026-01-04 10:00:00
updated_at: 2026-01-04 10:00:00
```

---

### tasks

**Purpose**: Store todo items created by users. Each task belongs to exactly one user via the user_id foreign key.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | BIGSERIAL | PRIMARY KEY | Auto-incrementing task identifier unique within the database |
| user_id | VARCHAR(255) | NOT NULL, FOREIGN KEY (users.id) | Owner of the task; enforces user isolation |
| title | VARCHAR(200) | NOT NULL | Task title; required, 1-200 characters |
| description | TEXT | NULL | Optional task description; max 1000 characters; defaults to null |
| completed | BOOLEAN | NOT NULL, DEFAULT FALSE | Completion status: false (pending), true (completed) |
| created_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | Task creation timestamp |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | Last modification timestamp |

**Example Rows**:

```
id: 1
user_id: 'user_abc123'
title: 'Buy groceries'
description: 'Milk, eggs, bread'
completed: false
created_at: 2026-01-04 10:15:00
updated_at: 2026-01-04 10:15:00

---

id: 2
user_id: 'user_abc123'
title: 'Finish project'
description: null
completed: true
created_at: 2026-01-03 15:30:00
updated_at: 2026-01-04 09:45:00

---

id: 3
user_id: 'user_xyz789'
title: "Alice's Secret Task"
description: 'Only Alice can see this'
completed: false
created_at: 2026-01-04 08:00:00
updated_at: 2026-01-04 08:00:00
```

---

## Indexes

Indexes optimize common query patterns and enforce constraints.

| Index Name | Table | Column(s) | Type | Purpose |
|------------|-------|-----------|------|---------|
| PRIMARY KEY | users | id | PRIMARY | Unique user lookup |
| UNIQUE(email) | users | email | UNIQUE | Prevent duplicate email registration |
| PRIMARY KEY | tasks | id | PRIMARY | Unique task lookup |
| FK(user_id) | tasks | user_id | FOREIGN KEY | Enforce referential integrity; allow cascading deletes (optional) |
| INDEX(user_id) | tasks | user_id | BTREE | Optimize filtering tasks by user (critical for list queries) |
| INDEX(completed) | tasks | completed | BTREE | Optimize filtering by completion status |
| INDEX(user_id, completed) | tasks | (user_id, completed) | BTREE | Composite index for filtering by user + status together |
| INDEX(user_id, created_at DESC) | tasks | (user_id, created_at DESC) | BTREE | Optimize fetching user's tasks sorted by creation date (newest first) |

**Index Creation SQL**:

```sql
CREATE INDEX idx_tasks_user_id ON tasks(user_id);
CREATE INDEX idx_tasks_completed ON tasks(completed);
CREATE INDEX idx_tasks_user_completed ON tasks(user_id, completed);
CREATE INDEX idx_tasks_user_created_desc ON tasks(user_id, created_at DESC);
```

---

## Relationships & Constraints

### Foreign Key: tasks.user_id â†’ users.id

**Constraint Definition**:

```sql
ALTER TABLE tasks ADD CONSTRAINT fk_tasks_user_id
  FOREIGN KEY (user_id) REFERENCES users(id);
```

**Behavior**:

- A task cannot be created with a user_id that doesn't exist in the users table
- Optionally, when a user is deleted, their tasks can be automatically deleted (ON DELETE CASCADE)
- For Phase II MVP, we assume users are never deleted; cascading delete can be added later

### Unique Constraint: users.email

**Constraint Definition**:

```sql
CREATE UNIQUE INDEX idx_users_email ON users(email);
```

**Behavior**:

- Two users cannot have the same email address
- Signup must check for email uniqueness before creating an account
- Database enforces this constraint; duplicate emails are rejected at the database level

---

## Timestamps & Audit Trail

**created_at**:
- Automatically set to the current server time when a row is inserted
- Never updated; reflects the original creation timestamp
- Used for sorting tasks chronologically

**updated_at**:
- Automatically set to the current server time when a row is inserted
- Updated to the current server time whenever the row is modified (title, description, completed status)
- Used to track when tasks were last changed

**UTC Timezone**: All timestamps are stored in UTC (Z suffix) for consistency across time zones.

---

## Data Validation (Application Level)

The ORM (SQLModel) enforces these validations before data is sent to the database:

| Field | Validation Rule | Error Message |
|-------|-----------------|----------------|
| title | Length 1-200 | "Title must be between 1 and 200 characters" |
| description | Length 0-1000 or null | "Description cannot exceed 1000 characters" |
| completed | Boolean (true/false) | "Completed must be true or false" |
| email | Valid email format | "Invalid email address" |

---

## Initialization & Migration

**Initial Schema Creation**:

```sql
-- Create users table (managed by Better Auth; this is for reference)
CREATE TABLE users (
  id VARCHAR(255) PRIMARY KEY,
  email VARCHAR(255) UNIQUE NOT NULL,
  password_hash TEXT NOT NULL,
  name VARCHAR(255) NOT NULL,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- Create tasks table
CREATE TABLE tasks (
  id BIGSERIAL PRIMARY KEY,
  user_id VARCHAR(255) NOT NULL REFERENCES users(id),
  title VARCHAR(200) NOT NULL,
  description TEXT,
  completed BOOLEAN NOT NULL DEFAULT FALSE,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- Create indexes
CREATE INDEX idx_tasks_user_id ON tasks(user_id);
CREATE INDEX idx_tasks_completed ON tasks(completed);
CREATE INDEX idx_tasks_user_completed ON tasks(user_id, completed);
CREATE INDEX idx_tasks_user_created_desc ON tasks(user_id, created_at DESC);
```

**Schema Evolution**:

- New columns should be added with `ALTER TABLE` statements in migration files
- Existing columns should never be removed (add `DEPRECATED` flag if needed)
- All migrations are reversible (include both UP and DOWN scripts)
- Migrations are version-controlled in the repository (e.g., `migrations/001_initial_schema.sql`)

---

## Performance Considerations

1. **User Isolation Index**: The `idx_tasks_user_id` index ensures fast filtering of tasks by user, critical for the GET /api/tasks endpoint
2. **Composite Index**: `idx_tasks_user_completed` allows efficient filtering by user + status in a single index scan
3. **Sorted Index**: `idx_tasks_user_created_desc` enables fast retrieval of a user's tasks sorted by creation date (newest first)
4. **Timestamp Indexes**: Avoid indexing created_at and updated_at individually; use them in composite indexes where needed

---

## Scalability & Limits

For Phase II MVP:

- **Maximum Tasks per User**: No artificial limit; can scale to 100,000+ tasks per user
- **Maximum Users**: No artificial limit; database can scale to millions of users
- **Maximum Description**: 1000 characters (TEXT column supports much larger values if needed later)
- **Row Size**: Estimated ~500 bytes per task row; manageable for Neon's serverless tier

---

## Data Retention & Deletion

**User Deletion Policy** (not implemented in MVP):

- When a user is deleted, all their tasks should be deleted (implement ON DELETE CASCADE)

**Task Deletion Policy**:

- Tasks are hard-deleted from the database immediately (no soft delete in MVP)
- No audit trail of deleted tasks is kept (can be added later with a separate audit table)

**Data Retention Period** (not applicable to MVP):

- All data is retained indefinitely unless explicitly deleted by the user
- No automatic expiration or archival of old tasks

---

## Neon-Specific Considerations

**Connection Pooling**:

- Neon uses a built-in connection pooler; ensure the FastAPI app uses appropriate pool settings
- Connection string format: `postgresql://<user>:<password>@<host>/<database>`

**Serverless Autoscaling**:

- Neon automatically scales compute resources based on demand
- No manual provisioning required
- Suitable for MVP workloads with variable usage patterns

**Backups**:

- Neon handles automated daily backups; retention and recovery details documented in Neon dashboard

---

## Out of Scope (Phase II)

- Task archival (soft delete)
- Task audit logs / change history
- Task versioning
- Denormalization or caching layer (Redis)
- Read replicas or database sharding
- Full-text search indexes on task titles/descriptions
